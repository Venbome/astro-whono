---
const { siteTitle = 'Whono' } = Astro.props;

const pathname = Astro.url.pathname;

const nav = [
  { label: '随笔', href: '/essay/' },
  { label: '小记', href: '/bits/' },
  { label: '孩童', href: '/kids/' },
  { label: '归档', href: '/posts/' },
  { label: '关于', href: '/about/' }
];

const quote = 'There is only one thing in\nthe world worse than being\ntalked about, and that is\nnot being talked about.';
---

<aside class="sidebar">
  <a class="sidebar__title" href="/" aria-label={`${siteTitle} 首页`}>{siteTitle}</a>

  <div class="sidebar__quote">
    {quote.split('\n').map((line) => (
      <>
        {line}<br />
      </>
    ))}
  </div>

  <ul class="nav">
    {nav.map((item) => {
      const isActive = pathname === item.href || (item.href !== '/' && pathname.startsWith(item.href));
      return (
        <li>
          <a href={item.href} aria-current={isActive ? 'page' : undefined}>
            <span>{item.label}</span>
            <span class="dot" aria-hidden="true"></span>
          </a>
        </li>
      );
    })}
  </ul>

  <div class="sidebar-actions">
    <button
      id="reader-toggle"
      class="icon-button reader-toggle"
      type="button"
      aria-label="进入阅读模式"
      aria-pressed="false"
      title="进入阅读模式"
    >
      <svg class="icon icon-book-open" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path
          d="M12 6c-2-1.3-4.5-2-7-2v14c2.5 0 5 .7 7 2"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M12 6c2-1.3 4.5-2 7-2v14c-2.5 0-5 .7-7 2"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
      <svg class="icon icon-book-closed" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path
          d="M7 4.5h9a2.5 2.5 0 0 1 2.5 2.5V19"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M7 19V4.5M7 19h9"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>

    <a class="icon-button rss-link" href="/posts/rss.xml" aria-label="RSS 订阅" title="RSS 订阅">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <circle cx="6" cy="18" r="1.8" fill="currentColor" />
        <path
          d="M4 11a9 9 0 0 1 9 9"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
        />
        <path
          d="M4 5a15 15 0 0 1 15 15"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
        />
      </svg>
    </a>

    <button
      id="theme-toggle"
      class="icon-button theme-toggle"
      type="button"
      aria-label="切换到深色模式"
      aria-pressed="false"
      title="切换到深色模式"
    >
      <svg class="icon icon-moon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path
          d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
      <svg class="icon icon-sun" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <circle
          cx="12"
          cy="12"
          r="4.2"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
        />
        <path
          d="M12 2.5v2.5M12 19v2.5M4.2 4.2l1.8 1.8M18 18l1.8 1.8M2.5 12h2.5M19 12h2.5M4.2 19.8l1.8-1.8M18 6l1.8-1.8"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
        />
      </svg>
    </button>
  </div>
</aside>

<script>
  const KEY = 'theme';
  const btn = document.getElementById('theme-toggle');
  const readerBtn = document.getElementById('reader-toggle');
  const readerExit = document.getElementById('reader-exit');
  const root = document.documentElement;
  const body = document.body;

  function isDark() {
    return root.dataset.theme === 'dark';
  }

  function apply(theme: string) {
    root.dataset.theme = theme;
    const dark = theme === 'dark';
    if (btn) {
      btn.setAttribute('aria-pressed', dark ? 'true' : 'false');
      const label = dark ? '切换到浅色模式' : '切换到深色模式';
      btn.setAttribute('aria-label', label);
      btn.setAttribute('title', label);
    }
  }

  btn?.addEventListener('click', () => {
    const next = isDark() ? 'light' : 'dark';
    apply(next);
    try { localStorage.setItem(KEY, next); } catch (_) {}
  });

  function isReaderOn() {
    return body?.dataset.reading === 'immersive';
  }

  function applyReader(on: boolean) {
    if (!body) return;
    if (on) {
      body.dataset.reading = 'immersive';
    } else {
      delete body.dataset.reading;
    }
    if (readerBtn) {
      const label = on ? '退出阅读模式' : '进入阅读模式';
      readerBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
      readerBtn.setAttribute('aria-label', label);
      readerBtn.setAttribute('title', label);
    }
    if (readerExit) {
      readerExit.setAttribute('aria-label', '退出阅读模式');
    }
  }

  readerBtn?.addEventListener('click', () => {
    applyReader(!isReaderOn());
  });

  readerExit?.addEventListener('click', () => {
    applyReader(false);
  });

  // 初始化按钮状态
  apply(isDark() ? 'dark' : 'light');
  applyReader(false);
</script>
