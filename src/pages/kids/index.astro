---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getEntry, render } from 'astro:content';

const prod = import.meta.env.PROD;

const entry = await getEntry('kids', 'index');
if (!entry) {
  throw new Error('Missing kids page entry: src/content/kids/index.md');
}
if (prod && entry.data.draft) {
  throw new Error('Kids entry is marked draft...');
}

const { Content, headings } = await render(entry);

// Build a grouped TOC: H2 as section titles, H3 as items.
type TocItem = { text: string; slug: string };
type TocGroup = { title: string; items: TocItem[] };

const groups: TocGroup[] = [];
let current: TocGroup | null = null;
for (const h of headings) {
  if (h.depth === 2) {
    current = { title: h.text, items: [] };
    groups.push(current);
  } else if (h.depth === 3) {
    if (!current) {
      current = { title: '目录', items: [] };
      groups.push(current);
    }
    current.items.push({ text: h.text, slug: h.slug });
  }
}
---

<BaseLayout title="孩童" bodyClass="kids-page immersive-page">
  <div class="page-header reader-exit-anchor">
    <h1 class="page-title">{entry.data.title}</h1>
    {entry.data.subtitle ? <span class="page-subtitle">{entry.data.subtitle}</span> : null}
    <button
      id="reader-exit"
      class="icon-button reader-exit"
      type="button"
      aria-label="退出阅读"
      title="退出阅读"
      aria-hidden="true"
      tabindex="-1"
    >
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path
          d="M6 4.5h9a2.5 2.5 0 0 1 2.5 2.5V19"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M6 19V4.5M6 19h9"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M14.2 12H10.6"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
        <path
          d="M10.6 12l2-2M10.6 12l2 2"
          fill="none"
          stroke="currentColor"
          stroke-width="1.6"
          stroke-linecap="round"
          stroke-linejoin="round"
        />
      </svg>
    </button>
  </div>

  <div class="intro">
    时间流经我们，如同风穿过回廊。
    <br />总有一些瞬间，携带着特别的气息或光亮，短暂停留后便消散。
    <br />有些感受，无法被镜头承载，有些记忆难以被影像收藏。
    <br />也许，为瞬间的感受留下一份文字备份，正是抵抗遗忘最温柔却最有效的方式。
  </div>

  <nav class="kids-toc" aria-label="目录">
    {groups.map((g) => (
      <details open>
        <summary>{g.title}</summary>
        <ul class="toc-items">
          {g.items.map((it, i) => (
            <li>
              <a href={`#${it.slug}`}>
                <span class="toc-num">{i + 1}</span>
                <span>{it.text}</span>
              </a>
            </li>
          ))}
        </ul>
      </details>
    ))}
  </nav>

  <div class="kids-content prose">
    <Content />
  </div>

  <script is:inline>
    (() => {
      const mq = window.matchMedia('(max-width: 640px)');
      const sync = () => {
        if (mq.matches) {
          document.querySelectorAll('.kids-toc details[open]').forEach((el) => {
            el.removeAttribute('open');
          });
        } else {
          document.querySelectorAll('.kids-toc details:not([open])').forEach((el) => {
            el.setAttribute('open', '');
          });
        }
      };
      sync();
      mq.addEventListener('change', sync);
    })();
  </script>
</BaseLayout>
